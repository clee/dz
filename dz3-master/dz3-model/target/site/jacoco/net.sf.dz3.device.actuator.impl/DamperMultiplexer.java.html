<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DamperMultiplexer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Model Abstractions and Implementation</a> &gt; <a href="index.source.html" class="el_package">net.sf.dz3.device.actuator.impl</a> &gt; <span class="el_source">DamperMultiplexer.java</span></div><h1>DamperMultiplexer.java</h1><pre class="source lang-java linenums">package net.sf.dz3.device.actuator.impl;

import java.io.IOException;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import java.util.concurrent.Callable;
import java.util.concurrent.Future;

import org.apache.logging.log4j.ThreadContext;

import net.sf.dz3.device.actuator.Damper;
import net.sf.dz3.instrumentation.Marker;
import net.sf.jukebox.jmx.JmxDescriptor;
import net.sf.servomaster.device.model.TransitionStatus;

/**
 * Damper multiplexer.
 *
 * Allows to control several physical dampers via one logical one. Each of controlled dampers
 * can be calibrated individually.
 *
 * @author Copyright &amp;copy; &lt;a href=&quot;mailto:vt@homeclimatecontrol.com&quot;&gt; Vadim Tkachenko&lt;/a&gt; 2001-2020
 */
public class DamperMultiplexer extends AbstractDamper {

    /**
     * Dampers to control.
     */
<span class="fc" id="L32">    private final Set&lt;Damper&gt; dampers = new HashSet&lt;&gt;();</span>

    /**
     * Our own position. Different from {@link AbstractDamper#position}.
     *
     * This variable doesn't participate in transitions, but is rather for reporting purposes.
     */
    private double multiPosition;

    /**
     * Create an instance.
     *
     * @param name Name to use.
     * @param dampers Set of dampers to control.
     * @param parkPosition Park position.
     */
    public DamperMultiplexer(String name, Set&lt;Damper&gt; dampers, Double parkPosition) {
<span class="fc" id="L49">        super(name);</span>

<span class="fc" id="L51">        this.dampers.addAll(dampers);</span>

<span class="pc bpc" id="L53" title="1 of 2 branches missed.">        if (parkPosition != null) {</span>
<span class="nc" id="L54">            setParkPosition(parkPosition);</span>
        }

<span class="fc" id="L57">        multiPosition = getParkPosition();</span>
<span class="fc" id="L58">    }</span>

    /**
     * Create an instance with default parking position.
     *
     * @param name Name to use.
     * @param dampers Set of dampers to control.
     */
    public DamperMultiplexer(String name, Set&lt;Damper&gt; dampers) {

<span class="fc" id="L68">        this(name, dampers, null);</span>
<span class="fc" id="L69">    }</span>

    @Override
    protected void moveDamper(double position) throws IOException {

<span class="fc" id="L74">        ThreadContext.push(&quot;moveDamper&quot;);</span>
<span class="fc" id="L75">        Marker m = new Marker(&quot;moveDamper&quot;);</span>

        try {

<span class="fc" id="L79">            multiPosition = position;</span>

<span class="fc" id="L81">            Map&lt;Damper, Double&gt; targetPosition = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">            for (Iterator&lt;Damper&gt; i = dampers.iterator(); i.hasNext(); ) {</span>

<span class="fc" id="L85">                targetPosition.put(i.next(), position);</span>
            }

<span class="fc" id="L88">            moveDampers(targetPosition);</span>

        } finally {
<span class="fc" id="L91">            m.close();</span>
<span class="fc" id="L92">            ThreadContext.pop();</span>
        }
<span class="fc" id="L94">    }</span>

    private void moveDampers(Map&lt;Damper, Double&gt; targetPosition) throws IOException {

<span class="fc" id="L98">        ThreadContext.push(&quot;moveDampers&quot;);</span>
        try {

<span class="fc" id="L101">            new Damper.MoveGroup(targetPosition).call();</span>

<span class="nc" id="L103">        } catch (Exception ex) {</span>
<span class="nc" id="L104">            throw new IOException(&quot;failed to move dampers?&quot;, ex);</span>
        } finally {
<span class="fc" id="L106">            ThreadContext.pop();</span>
        }
<span class="fc" id="L108">    }</span>

    @Override
    public synchronized double getPosition() throws IOException {

<span class="fc" id="L113">        return multiPosition;</span>
    }

    @Override
    public JmxDescriptor getJmxDescriptor() {

<span class="nc" id="L119">        return new JmxDescriptor(</span>
                &quot;dz&quot;,
                &quot;Damper multiplexer&quot;,
<span class="nc" id="L122">                Integer.toHexString(hashCode()),</span>
<span class="nc" id="L123">                &quot;Controls &quot; + dampers.size() + &quot; dampers&quot;);</span>
    }

    @Override
    public Future&lt;TransitionStatus&gt; park() {

        // VT: NOTE: This object is bogus - the whole concept needs to be revisited; see #132

<span class="fc" id="L131">        int authToken = hashCode();</span>
<span class="fc" id="L132">        TransitionStatus result = new TransitionStatus(authToken);</span>

<span class="fc" id="L134">        Callable&lt;TransitionStatus&gt; c = () -&gt; {</span>


<span class="fc" id="L137">            Marker m = new Marker(&quot;park/multi&quot;);</span>
<span class="fc" id="L138">            ThreadContext.push(&quot;park/multi&quot;);</span>

            try {

<span class="fc" id="L142">                multiPosition = getParkPosition();</span>

                // Need to park dampers at their individual positions if they were specified,
                // or to the multiplexer parking position if they weren't.

<span class="fc" id="L147">                Map&lt;Damper, Double&gt; targetPosition = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">                for (Iterator&lt;Damper&gt; i = dampers.iterator(); i.hasNext(); ) {</span>

<span class="fc" id="L151">                    Damper d = i.next();</span>
<span class="fc" id="L152">                    boolean custom = d.isCustomParkPosition();</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">                    double position = custom ? d.getParkPosition() : getParkPosition();</span>

<span class="fc" id="L155">                    targetPosition.put(d, position);</span>

<span class="fc bfc" id="L157" title="All 2 branches covered.">                    logger.debug(&quot;{}: {} ({})&quot;, d.getName(), position, custom ? &quot;custom&quot; : &quot;multiplexer&quot;);</span>

<span class="fc bfc" id="L159" title="All 2 branches covered.">                    if (custom) {</span>
<span class="fc" id="L160">                        logger.warn(&quot;{} will be parked at custom position {}, consider changing hardware layout so override is not necessary&quot;, d.getName(), position);</span>
                    }
<span class="fc" id="L162">                }</span>

<span class="fc" id="L164">                moveDampers(targetPosition);</span>

<span class="fc" id="L166">                result.complete(authToken, null);</span>
<span class="fc" id="L167">                return result;</span>

            } finally {

<span class="fc" id="L171">                m.close();</span>
<span class="fc" id="L172">                ThreadContext.pop();</span>
<span class="fc" id="L173">                ThreadContext.clearStack();</span>
            }
        };

<span class="fc" id="L177">        Future&lt;TransitionStatus&gt; done = getExecutor().submit(c);</span>

<span class="fc" id="L179">        releaseExecutor();</span>

<span class="fc" id="L181">        return done;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>