<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThermostatRenderer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MQTT Connector</a> &gt; <a href="index.source.html" class="el_package">net.sf.dz3.view.mqtt.v1</a> &gt; <span class="el_source">ThermostatRenderer.java</span></div><h1>ThermostatRenderer.java</h1><pre class="source lang-java linenums">package net.sf.dz3.view.mqtt.v1;

import java.io.StringWriter;
import java.util.Map;

import javax.json.Json;
import javax.json.JsonObject;
import javax.json.JsonObjectBuilder;
import javax.json.JsonWriter;

import org.apache.logging.log4j.LogManager;
import org.joda.time.DateTime;

import net.sf.dz3.controller.pid.AbstractPidController;
import net.sf.dz3.device.model.HvacMode;
import net.sf.dz3.device.model.ThermostatSignal;
import net.sf.dz3.device.model.ZoneState;
import net.sf.dz3.device.model.impl.ThermostatModel;
import net.sf.dz3.scheduler.Period;
import net.sf.dz3.scheduler.Scheduler;
import net.sf.dz3.scheduler.Scheduler.Deviation;
import net.sf.jukebox.datastream.signal.model.DataSample;
import net.sf.jukebox.datastream.signal.model.DataSink;

/**
/**
 * Keeps {@link #consume(DataSample) receiving} data notifications and
 * {@link #emit(ZoneSnapshot) stuffing} them into the queue. 
 * 
 * @author Copyright &amp;copy; &lt;a href=&quot;mailto:vt@freehold.crocodile.org&quot;&gt;Vadim Tkachenko&lt;/a&gt; 2001-2019
 */

public class ThermostatRenderer extends QueueFeeder&lt;UpstreamBlock&gt; implements DataSink&lt;ThermostatSignal&gt;, JsonRenderer&lt;DataSample&lt;ThermostatSignal&gt;&gt; {

    private final ThermostatModel source;
    private final Scheduler scheduler;
    
    public ThermostatRenderer(ThermostatModel source, Map&lt;String, Object&gt; context, Scheduler scheduler) {
        
<span class="nc" id="L40">        super(context);</span>

<span class="nc" id="L42">        this.source = source;</span>
<span class="nc" id="L43">        this.scheduler = scheduler;</span>

        // VT: NOTE: This is a simplification sufficient until the server side framework
        // is ironed out. Later, the controller signal needs to be added, just like it is
        // done in ThermostatPanel.
        
<span class="nc" id="L49">        source.addConsumer(this);</span>
<span class="nc" id="L50">    }</span>

    /**
     * VT: FIXME: Create {@code MqttRenderer}
     */
    private String getTopic() {
<span class="nc" id="L56">        return &quot;thermostat/&quot; + source.getName();</span>
    }

    @Override
    public void consume(DataSample&lt;ThermostatSignal&gt; signal) {
        
<span class="nc" id="L62">        emit(new UpstreamBlock(getTopic(), render(signal)));</span>
<span class="nc" id="L63">    }</span>

    /**
     * Find out the name of the current period for the zone served by this renderer.
     *
     * @return {@code null} if there's no scheduler, a predefined string if there's no period, or a period name.
     */
    private String getPeriod() {
        
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (scheduler == null) {</span>
<span class="nc" id="L73">            return null;</span>
        }

<span class="nc" id="L76">        Period p = scheduler.getCurrentPeriod(source);</span>
        
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L79">            return &quot;(no period is active)&quot;;</span>
        }
        
<span class="nc" id="L82">        return p.name;</span>
    }

    @Override
    public String render(DataSample&lt;ThermostatSignal&gt; signal) {
        
<span class="nc" id="L88">        String name = source.getName();</span>
        // VT: FIXME: Is it even possible to use anything other than PID controller?
<span class="nc bnc" id="L90" title="All 2 branches missed.">        HvacMode mode = ((AbstractPidController) source.getController()).getP() &gt; 0 ? HvacMode.COOLING : HvacMode.HEATING;</span>
<span class="nc bnc" id="L91" title="All 6 branches missed.">        ZoneState state = signal.isError() ? ZoneState.ERROR : (signal.sample.enabled ? (signal.sample.calling ? ZoneState.CALLING : ZoneState.HAPPY) : ZoneState.OFF);</span>
<span class="nc" id="L92">        double thermostatSignal = signal.sample.demand.sample;</span>

        double currentTemperature;
        
<span class="nc" id="L96">        DataSample&lt;Double&gt; sample = source.getSensor().getSignal();</span>
        
        // It would be a good idea to use Double.NaN for null and error cases. However,
        // this would later violate JSON specification, so let's leave this at 0 and see how it works.
        
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (sample == null) {</span>
            
<span class="nc" id="L103">            LogManager.getLogger(getClass()).debug(&quot;current=null&quot;);</span>
<span class="nc" id="L104">            currentTemperature = 0;</span>
            
<span class="nc bnc" id="L106" title="All 2 branches missed.">        } else if ( sample.isError() ) {</span>
            
<span class="nc" id="L108">            LogManager.getLogger(getClass()).debug(&quot;current=error&quot;);</span>
<span class="nc" id="L109">            currentTemperature = 0;</span>
        
        } else {
            
<span class="nc" id="L113">            currentTemperature = sample.sample;</span>
        }
        
<span class="nc" id="L116">        double setpointTemperature = source.getController().getSetpoint();</span>
<span class="nc" id="L117">        boolean enabled = signal.sample.enabled;</span>
<span class="nc" id="L118">        boolean onHold = signal.sample.onHold;</span>
<span class="nc" id="L119">        boolean voting = signal.sample.voting;</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        String error = signal.isError() ? signal.error.getMessage() : null;</span>
        
<span class="nc" id="L122">        String periodName = getPeriod();</span>
        
<span class="nc bnc" id="L124" title="All 2 branches missed.">        Deviation deviation = scheduler == null ? new Deviation(0, false, false) : scheduler.getDeviation(source, setpointTemperature, enabled, voting, new DateTime(signal.timestamp));</span>
            
<span class="nc" id="L126">        JsonObjectBuilder b = Json.createObjectBuilder();</span>

<span class="nc" id="L128">        b.add(&quot;entityType&quot;, MqttConnector.EntityType.THERMOSTAT.toString());</span>
<span class="nc" id="L129">        b.add(&quot;timestamp&quot;, signal.timestamp);</span>
<span class="nc" id="L130">        b.add(&quot;name&quot;, name);</span>
<span class="nc" id="L131">        b.add(&quot;signature&quot;, signal.signature);</span>
<span class="nc" id="L132">        b.add(&quot;mode&quot;, mode.description);</span>
<span class="nc" id="L133">        b.add(&quot;state&quot;, state.toString());</span>
<span class="nc" id="L134">        b.add(&quot;thermostatSignal&quot;, thermostatSignal);</span>
<span class="nc" id="L135">        b.add(&quot;currentTemperature&quot;, currentTemperature);</span>
<span class="nc" id="L136">        b.add(&quot;setpointTemperature&quot;, setpointTemperature);</span>
<span class="nc" id="L137">        b.add(&quot;enabled&quot;, enabled);</span>
<span class="nc" id="L138">        b.add(&quot;onHold&quot;, onHold);</span>
<span class="nc" id="L139">        b.add(&quot;voting&quot;, voting);</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (periodName != null) {</span>
<span class="nc" id="L142">            b.add(&quot;periodName&quot;, periodName);</span>
        }

<span class="nc" id="L145">        b.add(&quot;deviation.setpoint&quot;, deviation.setpoint);</span>
<span class="nc" id="L146">        b.add(&quot;deviation.enabled&quot;, deviation.enabled);</span>
<span class="nc" id="L147">        b.add(&quot;deviation.voting&quot;, deviation.voting);</span>

<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (error != null) {</span>
<span class="nc" id="L150">            b.add(&quot;error&quot;, error);</span>
        }

<span class="nc" id="L153">        JsonObject message = b.build();</span>
<span class="nc" id="L154">        StringWriter sw = new StringWriter();</span>
<span class="nc" id="L155">        JsonWriter jw = Json.createWriter(sw);</span>

<span class="nc" id="L157">        jw.writeObject(message);</span>
<span class="nc" id="L158">        jw.close();</span>

<span class="nc" id="L160">        return sw.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>